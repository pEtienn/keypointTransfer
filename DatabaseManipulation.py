# -*- coding: utf-8 -*-
"""
Created on Tue Aug 13 20:51:52 2019

@author: Etenne Pepyn
"""

import os
import numpy as np 
import nibabel as nib
import re

def CombineSegmentations(srcPath,outPath):
    rLabelNumber=re.compile('(wb|Ab)_([0-9]+)_')
    rVolumeID=re.compile('(^.+[wb|Ab])_')
    
    allF=os.listdir(srcPath)
    unreadableFile=' '
    previousOutput=' '
    affine = np.diag([1, 2, 3, 1])
    for f in allF: 
        shortName=rVolumeID.findall(f)[0]
        if shortName!=unreadableFile:
            outputName=outPath+shortName+'.nii.gz'
            try:
                if previousOutput!=outputName:
                    img=nib.load(srcPath+f)
                    h=img.header
                    shape=h.get_data_shape()   
                    if previousOutput!=' ' and shortName!=unreadableFile:
                        print(previousOutput)
                        arrayImg = nib.Nifti1Image(segArray, affine)
                        nib.save(arrayImg,previousOutput) 
                    segArray=np.zeros(shape)
                else:
                    img=nib.load(srcPath+f)
                arr=img.get_fdata()
                uni=np.unique(arr)
                if np.shape(uni)[0]>1:
                    if uni[1]==1:
                        k=rLabelNumber.findall(f)[0][1]
                        n=int(k[0])
                        arr=arr*n
                segArray=segArray+arr
            except:
                print('problem loading '+f+', skipping '+shortName)
                unreadableFile=shortName

        previousOutput=outputName
    if shortName!=unreadableFile:
        arrayImg = nib.Nifti1Image(segArray, affine)
        nib.save(arrayImg,outputName) 

def SelectLabelInSegmentation(srcPath,outPath,labelToKeep):
    """
    Takes all the segmentation files generated by CombineSegmentations and generates new
    segmentations files containing only labels specified by labelToKeep
     *** INPUT ***
    srcPath: path to output of CombineSegmentations
    outPath: destination of new segmentations files
    labelToKeep: list containing labels to keep
    """
    affine = np.diag([1, 2, 3, 1])
    allF=os.listdir(srcPath)
    for f in allF: 
        img=nib.load(srcPath+f)
        arr=img.get_fdata()
        outArr=np.zeros(arr.shape)
        for i in range(len(labelToKeep)):
            outArr=outArr+(arr==labelToKeep[i])*labelToKeep[i]
        arrayImg = nib.Nifti1Image(outArr, affine)
        nib.save(arrayImg,outPath+f) 